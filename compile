#!/bin/bash

set -o errexit  # exit on error
set -o pipefail # trap pipe fails
set -o nounset  # trap unset vars
# set -o xtrace
################################################################################

EMACS_REPO="git://git.savannah.gnu.org/emacs.git"
LOCAL_EMACS="/tmp/emacs"
EMACS_GIT="$HOME/gits/emacs"
INSTALL_DIR="/opt/emacs"


if false ; then
    git clone "$EMACS_REPO" --depth=1 "$LOCAL_EMACS"
else
    [[ -e "$LOCAL_EMACS" ]] && rm -rf "$LOCAL_EMACS"
    mkdir "$LOCAL_EMACS"
    cp -a "$EMACS_GIT/" "$LOCAL_EMACS/.."
fi

cd "$LOCAL_EMACS"

./autogen.sh
./configure \
 --prefix="$INSTALL_DIR" \
 --with-cairo \
 --with-libsystemd \
 --with-mailutils \
 --with-native-compilation \
 --with-pop=yes \
 --with-sound=alsa \
 --with-toolkit-scroll-bars \
 --with-x-toolkit=gtk3 \
 --with-x=yes \
 --without-gconf \
 'CFLAGS=-g -O2'

make -j5

echo -e "\nNow \`mkdir /opt/emacs\` if necessary"
echo "and \`make install -j5\`"
